---
- name: Prepare media-services VM for storage migration
  hosts: media-services
  become: true

  tasks:
    - name: Stop Docker containers gracefully
      ansible.builtin.command:
        cmd: docker compose -f /opt/media-stack/docker-compose.yml down
      args:
        chdir: /opt/media-stack
      failed_when: false
      changed_when: true

    - name: Unmount NFS if mounted
      ansible.builtin.command:
        cmd: umount /data
      failed_when: false
      changed_when: true

- name: Configure VirtioFS on Proxmox host
  hosts: proxmox
  become: true

  vars:
    vm_id: 100
    host_path: /tank-media/data
    mount_tag: data

  tasks:
    - name: Check if VirtioFS already configured
      ansible.builtin.shell:
        cmd: set -o pipefail && qm config {{ vm_id }} | grep -q "^args:.*virtfs"
      args:
        executable: /bin/bash
      register: virtfs_exists
      failed_when: false
      changed_when: false

    - name: Shutdown VM for VirtioFS configuration
      ansible.builtin.command:
        cmd: qm shutdown {{ vm_id }}
      when: virtfs_exists.rc != 0
      changed_when: true

    - name: Wait for VM to shutdown
      ansible.builtin.pause:
        seconds: 15
      when: virtfs_exists.rc != 0

    - name: Add VirtioFS to VM config
      ansible.builtin.lineinfile:
        path: /etc/pve/qemu-server/{{ vm_id }}.conf
        regexp: '^args:'
        line: 'args: -virtfs local,id={{ mount_tag }},path={{ host_path }},security_model=none,mount_tag={{ mount_tag }}'
        state: present
      when: virtfs_exists.rc != 0
      register: virtfs_config

    - name: Start VM with VirtioFS
      ansible.builtin.command:
        cmd: qm start {{ vm_id }}
      when: virtfs_exists.rc != 0
      changed_when: true

    - name: Wait for VM to be ready
      ansible.builtin.wait_for:
        host: 192.168.20.191
        port: 22
        delay: 15
        timeout: 120
      when: virtfs_exists.rc != 0

    - name: Verify VirtioFS configuration
      ansible.builtin.shell:
        cmd: set -o pipefail && qm config {{ vm_id }} | grep "^args:"
      args:
        executable: /bin/bash
      register: vm_config
      changed_when: false

    - name: Display VirtioFS config
      ansible.builtin.debug:
        var: vm_config.stdout_lines

- name: Configure VirtioFS mount on media-services VM
  hosts: media-services
  become: true

  vars:
    mount_point: /data
    mount_tag: data
    nfs_server: 192.168.0.101
    nfs_export: /tank-media/data

  tasks:
    - name: Remove NFS entry from fstab
      ansible.builtin.lineinfile:
        path: /etc/fstab
        regexp: "{{ nfs_server }}:{{ nfs_export }}"
        state: absent

    - name: Ensure mount point directory exists
      ansible.builtin.file:
        path: "{{ mount_point }}"
        state: directory
        mode: '0755'

    - name: Add VirtioFS mount to fstab
      ansible.builtin.lineinfile:
        path: /etc/fstab
        line: "{{ mount_tag }} {{ mount_point }} 9p trans=virtio,version=9p2000.L,msize=104857600 0 0"
        state: present

    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Mount VirtioFS
      ansible.posix.mount:
        path: "{{ mount_point }}"
        src: "{{ mount_tag }}"
        fstype: 9p
        opts: trans=virtio,version=9p2000.L,msize=104857600
        state: mounted

    - name: Verify mount
      ansible.builtin.shell:
        cmd: set -o pipefail && mount | grep "{{ mount_point }}"
      args:
        executable: /bin/bash
      register: verify_mount
      changed_when: false

    - name: Display mount info
      ansible.builtin.debug:
        var: verify_mount.stdout_lines

    - name: Verify mount is 9p type (VirtioFS)
      ansible.builtin.assert:
        that:
          - "'9p' in verify_mount.stdout or 'virtio' in verify_mount.stdout"
        fail_msg: "Mount type is not 9p/VirtioFS"
        success_msg: "VirtioFS mount configured correctly"

    - name: Test hardlink creation
      block:
        - name: Create test file in downloads
          ansible.builtin.file:
            path: "{{ mount_point }}/downloads/hardlink-test"
            state: touch
            mode: '0644'

        - name: Create hardlink in media
          ansible.builtin.file:
            src: "{{ mount_point }}/downloads/hardlink-test"
            dest: "{{ mount_point }}/media/hardlink-test"
            state: hard
            mode: '0644'

        - name: Get inodes
          ansible.builtin.stat:
            path: "{{ item }}"
          register: inode_check
          loop:
            - "{{ mount_point }}/downloads/hardlink-test"
            - "{{ mount_point }}/media/hardlink-test"

        - name: Verify hardlinks work
          ansible.builtin.assert:
            that:
              - inode_check.results[0].stat.inode == inode_check.results[1].stat.inode
            fail_msg: "Hardlinks not working - different inodes"
            success_msg: "Hardlinks working correctly - same inode {{ inode_check.results[0].stat.inode }}"

        - name: Cleanup test files
          ansible.builtin.file:
            path: "{{ item }}"
            state: absent
          loop:
            - "{{ mount_point }}/downloads/hardlink-test"
            - "{{ mount_point }}/media/hardlink-test"

    - name: Start Docker containers
      ansible.builtin.command:
        cmd: docker compose -f /opt/media-stack/docker-compose.yml up -d
      args:
        chdir: /opt/media-stack
      changed_when: true

    - name: Wait for containers to start
      ansible.builtin.pause:
        seconds: 15

    - name: Verify containers running
      ansible.builtin.command:
        cmd: docker ps --format "table {{ '{{' }}.Names{{ '}}' }}\t{{ '{{' }}.Status{{ '}}' }}"
      register: containers
      changed_when: false

    - name: Display container status
      ansible.builtin.debug:
        var: containers.stdout_lines
